#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

export LAUNCHPAD_API="https://api.staging.launchpad.net/"

# create
mir-bug create -o bug_id somerville bronn "some Dell platforms"
BUG_ID=$(cat bug_id)
lp-bug cleanup --yes "$BUG_ID"
rm bug_id

# collect
mir-bug collect "$AUTOPKGTEST_ARTIFACTS"/oem-meta-mir-bugs.json
mir-bug collect --ubuntu-certified "$AUTOPKGTEST_ARTIFACTS"/oem-meta-mir-bugs-ubuntu-certified.json

# check & update
BUG_ID="$(basename "$(jq -r '.[] | .bug' < "$AUTOPKGTEST_ARTIFACTS"/oem-meta-mir-bugs.json | sort | head -n 1)")"
mir-bug update --yes --skip --ready "$BUG_ID"

mir-bug check --skip --ready "$BUG_ID"

mir-bug update --yes --skip --tz=UTC "$BUG_ID"

mir-bug check --skip --tz=UTC "$BUG_ID"

exit 77
