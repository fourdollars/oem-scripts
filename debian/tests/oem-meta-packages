#!/bin/sh

cd "$AUTOPKGTEST_ARTIFACTS" || exit 1

cat > platforms.json << ENDLINE
[
  {
    "Customer": "Dell",
    "Group": "N/A",
    "Codename": "fossa-beric-icl",
    "Platform": "Bullseye V3 14 ICL-U(SMB0)",
    "MarketName": "Vostro 3401",
    "PlatformLPTag": "fossa-beric-icl"
  },
  {
    "Customer": "Dell",
    "Group": "N/A",
    "Codename": "fossa-beric-icl",
    "Platform": "Bullseye V3 15 ICL-U(SMB0)",
    "MarketName": "Vostro 3501",
    "PlatformLPTag": "fossa-beric-icl"
  },
  {
    "Customer": "Dell",
    "Group": "N/A",
    "Codename": "fossa-beric-icl",
    "Platform": "Bullseye N3 15 ICL-U(SMB0) ",
    "MarketName": "Inspiron 3501",
    "PlatformLPTag": "fossa-beric-icl"
  }
]
ENDLINE

export LAUNCHPAD_API="https://api.launchpad.net/"

oem-meta-packages --quiet list

oem-meta-packages collect platforms.json -o meta-info.json

oem-meta-packages --dry-run update --json meta-info.json

sed -i 's/"staging_version":.*/"staging_version": "20.04ubuntu2"/' meta-info.json # lower the staging version to simulate

oem-meta-packages --dry-run staging-copy --json meta-info.json

oem-meta-packages --dry-run staging-copy --ignore-staging-lock --json meta-info.json

for project in somerville stella sutton; do
    meta="$(apt-cache search oem-"$project" | awk '{print $1}' | shuf | head -n 1)"
    oem-meta-packages --dry-run update --meta "$meta" --factory
done
